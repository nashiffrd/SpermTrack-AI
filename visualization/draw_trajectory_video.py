# -*- coding: utf-8 -*-
"""draw_trajectory

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gbe-kvoKq-HK-VNpWuVLEhAczmHEF7jC
"""

import cv2
import pandas as pd
import numpy as np
import random
import os


def draw_trajectory_video(
    video_path,
    tracks_csv,
    output_path,
    max_history=30,
    draw_id=True
):
    """
    Draw sperm trajectories based on final_tracks.csv

    Parameters
    ----------
    video_path : str
        Path to original video
    tracks_csv : str
        final_tracks.csv from trackpy
    output_path : str
        Output annotated video
    max_history : int
        Number of past points to draw
    draw_id : bool
        Draw particle ID near sperm
    """

    df = pd.read_csv(tracks_csv)

    cap = cv2.VideoCapture(video_path)
    if not cap.isOpened():
        raise IOError("Cannot open video")

    fps = cap.get(cv2.CAP_PROP_FPS)
    w   = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
    h   = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))

    fourcc = cv2.VideoWriter_fourcc(*"mp4v")
    out = cv2.VideoWriter(output_path, fourcc, fps, (w, h))

    # group by frame
    tracks_by_frame = df.groupby("frame")

    # store trajectory history
    history = {}
    colors = {}

    frame_idx = 0

    while True:
        ret, frame = cap.read()
        if not ret:
            break

        if frame_idx in tracks_by_frame.groups:
            frame_tracks = tracks_by_frame.get_group(frame_idx)

            for _, row in frame_tracks.iterrows():
                pid = int(row["particle"])
                x, y = int(row["x"]), int(row["y"])

                if pid not in history:
                    history[pid] = []
                    colors[pid] = (
                        random.randint(50,255),
                        random.randint(50,255),
                        random.randint(50,255)
                    )

                history[pid].append((x, y))
                history[pid] = history[pid][-max_history:]

        # draw all trajectories
        for pid, points in history.items():
            if len(points) < 2:
                continue

            pts = np.array(points, np.int32).reshape((-1,1,2))
            cv2.polylines(frame, [pts], False, colors[pid], 2)

            if draw_id:
                px, py = points[-1]
                cv2.putText(
                    frame,
                    f"ID {pid}",
                    (px + 4, py - 4),
                    cv2.FONT_HERSHEY_SIMPLEX,
                    0.4,
                    colors[pid],
                    1
                )

        out.write(frame)
        frame_idx += 1

    cap.release()
    out.release()

    print(f"âœ… Trajectory video saved to: {output_path}")

